#!/usr/bin/env bash
set -euo pipefail

# Wavemill - Autonomous AI Workflow CLI
# Entry point for mill and expand workflows

VERSION="1.0.0"
SOURCE="${BASH_SOURCE[0]}"
while [[ -L "$SOURCE" ]]; do
  DIR="$(cd "$(dirname "$SOURCE")" && pwd)"
  SOURCE="$(readlink "$SOURCE")"
  [[ "$SOURCE" != /* ]] && SOURCE="$DIR/$SOURCE"
done
SCRIPT_DIR="$(cd "$(dirname "$SOURCE")" && pwd)"
LIB_DIR="$SCRIPT_DIR/shared/lib"
export TOOLS_DIR="${TOOLS_DIR:-$SCRIPT_DIR/tools}"

# Colors for output
CYAN=$'\033[0;36m'
GREEN=$'\033[0;32m'
YELLOW=$'\033[1;33m'
RED=$'\033[0;31m'
NC=$'\033[0m' # No Color

# Warn if ~/.claude/tools has drifted from the repo
check_claude_sync() {
  local claude_tools="$HOME/.claude/tools"
  [[ -d "$claude_tools" ]] || return 0

  local drifted=()
  for file in expand-issue.ts auto-label-issue.ts plan-initiative.ts; do
    if [[ -f "$claude_tools/$file" ]] && [[ -f "$TOOLS_DIR/$file" ]]; then
      if ! diff -q "$TOOLS_DIR/$file" "$claude_tools/$file" >/dev/null 2>&1; then
        drifted+=("$file")
      fi
    fi
  done

  if [[ ${#drifted[@]} -gt 0 ]]; then
    echo -e "${YELLOW}Warning:${NC} ~/.claude/tools is out of sync with repo (${drifted[*]})"
    echo -e "  Run: ${CYAN}$SCRIPT_DIR/sync-claude.sh to-claude${NC}"
    echo ""
  fi
}

show_help() {
  cat <<EOF
${CYAN}Wavemill${NC} v${VERSION} - Autonomous AI Workflow CLI

${GREEN}Usage:${NC}
  wavemill <command> [options]

${GREEN}Commands:${NC}
  ${CYAN}mill${NC}      Start continuous task execution loop
             - Fetches prioritized Linear backlog
             - Auto-expands issues without task packets
             - Launches parallel agents in tmux
             - Monitors PRs and auto-cleans completed work
             - Continuously prompts for next batch
             Options:
               ${CYAN}--agent <name>${NC}  Agent CLI to use (claude, codex, ...)

  ${CYAN}expand${NC}    Batch expand Linear issues
             - Shows ranked backlog candidates
             - Select up to 3 issues interactively
             - Expands with Claude + auto-labels
             - Updates Linear with detailed task packets

  ${CYAN}plan${NC}      Decompose a Linear initiative into issues
             - Fetches initiatives from configured project
             - Prioritizes those without existing issues
             - Select one to decompose with Claude
             - Creates phased milestones and issues in Linear

  ${CYAN}eval${NC}      Evaluate LLM performance on a completed workflow
             - Auto-detects recent workflow context
             - Invokes LLM-as-judge with structured rubric
             - Prints scored evaluation summary (0â€“1 scale)
             Subcommands:
               ${CYAN}eval report${NC}  Aggregate eval statistics and trends
                            --from, --to, --model, --limit, --json
               ${CYAN}eval export${NC}  Export records for ML training
                            --format csv|jsonl, --redact, --output FILE

  ${CYAN}init${NC}      Generate a template .wavemill-config.json in the current directory

  ${CYAN}version${NC}   Show version information
  ${CYAN}help${NC}      Show this help message

${GREEN}Examples:${NC}
  # Initialize config in your repo
  wavemill init

  # Start continuous loop (default: 3 parallel tasks)
  wavemill mill

  # Start mill with a specific agent
  wavemill mill --agent codex

  # Override a config value with an env var
  MAX_PARALLEL=5 wavemill mill

  # Expand issues interactively
  wavemill expand

  # Evaluate most recent completed workflow
  wavemill eval

  # Evaluate a specific issue and PR
  wavemill eval --issue HOK-123 --pr 456

  # View aggregate eval report
  wavemill eval report

  # Filter report by model and date range
  wavemill eval report --model claude-opus-4-6 --from 2026-01-01

  # Export eval records for ML training
  wavemill eval export --format csv --redact -o dataset.csv

${GREEN}Configuration:${NC}
  Settings are loaded in this order (later wins):
    1. Hardcoded defaults
    2. ${CYAN}~/.wavemill/config.json${NC}    (user-level, shared across repos)
    3. ${CYAN}.wavemill-config.json${NC}      (per-repo, in project root)
    4. Environment variables          (always override)

  Run ${CYAN}wavemill init${NC} to generate a template config file.
  See ${CYAN}wavemill-config.schema.json${NC} for full schema documentation.

${GREEN}Environment Variable Overrides:${NC}
  All config file settings can be overridden with env vars:
    LINEAR_API_KEY    Required: Linear API token (not in config - use .env)
    DRY_RUN           Dry run mode (env-only, default: false)
    MAX_PARALLEL      Number of parallel tasks
    SESSION           Tmux session name
    AGENT_CMD         Agent to use (claude, codex)
    WORKTREE_ROOT     Worktree location
    BASE_BRANCH       Base branch
    POLL_SECONDS      PR polling interval
    REQUIRE_CONFIRM   Require confirmations
    MAX_SELECT        Max issues to select for expansion
    MAX_DISPLAY       Max issues to display

${GREEN}Learn more:${NC}
  README: $SCRIPT_DIR/README.md

EOF
}

show_version() {
  echo "Wavemill v${VERSION}"
  echo "Location: $SCRIPT_DIR"
}

run_mill() {
  local mill_script="$LIB_DIR/wavemill-mill.sh"

  if [[ ! -f "$mill_script" ]]; then
    echo -e "${RED}Error:${NC} Mill script not found at: $mill_script" >&2
    exit 1
  fi

  if [[ ! -x "$mill_script" ]]; then
    chmod +x "$mill_script"
  fi

  echo -e "${CYAN}Starting Wavemill Mill...${NC}"
  exec "$mill_script" "$@"
}

run_init() {
  local target=".wavemill-config.json"

  if [[ -f "$target" ]]; then
    echo -e "${YELLOW}Warning:${NC} $target already exists"
    read -p "Overwrite? [y/N] " -n 1 -r
    echo
    [[ $REPLY =~ ^[Yy]$ ]] || exit 0
  fi

  cat > "$target" <<'INIT_EOF'
{
  "linear": {
    "project": ""
  },
  "mill": {
    "session": "wavemill",
    "maxParallel": 3,
    "pollSeconds": 10,
    "baseBranch": "main",
    "worktreeRoot": "../worktrees",
    "agentCmd": "claude",
    "requireConfirm": true,
    "maxRetries": 3,
    "retryDelay": 2
  },
  "expand": {
    "maxSelect": 3,
    "maxDisplay": 9
  }
}
INIT_EOF

  echo -e "${GREEN}Created${NC} $target"
  echo -e "Edit ${CYAN}linear.project${NC} to set your Linear project name."
  echo -e "All values shown are defaults - remove any you don't need to override."
}

run_expand() {
  local expand_script="$LIB_DIR/wavemill-expand.sh"

  if [[ ! -f "$expand_script" ]]; then
    echo -e "${RED}Error:${NC} Expand script not found at: $expand_script" >&2
    exit 1
  fi

  if [[ ! -x "$expand_script" ]]; then
    chmod +x "$expand_script"
  fi

  echo -e "${CYAN}Starting Wavemill Expand...${NC}"
  exec "$expand_script" "$@"
}

run_eval() {
  # Check for eval subcommands before falling through to eval-workflow.ts
  case "${1:-}" in
    report)
      shift
      run_eval_report "$@"
      return
      ;;
    export)
      shift
      run_eval_export "$@"
      return
      ;;
  esac

  local eval_tool="$TOOLS_DIR/eval-workflow.ts"

  if [[ ! -f "$eval_tool" ]]; then
    echo -e "${RED}Error:${NC} Eval tool not found at: $eval_tool" >&2
    exit 1
  fi

  echo -e "${CYAN}Starting Wavemill Eval...${NC}"
  exec npx tsx "$eval_tool" "$@"
}

run_eval_report() {
  local report_script="$LIB_DIR/wavemill-eval-report.sh"

  if [[ ! -f "$report_script" ]]; then
    echo -e "${RED}Error:${NC} Eval report script not found at: $report_script" >&2
    exit 1
  fi

  if [[ ! -x "$report_script" ]]; then
    chmod +x "$report_script"
  fi

  exec "$report_script" "$@"
}

run_eval_export() {
  local export_tool="$TOOLS_DIR/eval-export.ts"

  if [[ ! -f "$export_tool" ]]; then
    echo -e "${RED}Error:${NC} Eval export tool not found at: $export_tool" >&2
    exit 1
  fi

  exec npx tsx "$export_tool" "$@"
}

run_plan() {
  local plan_script="$LIB_DIR/wavemill-plan.sh"

  if [[ ! -f "$plan_script" ]]; then
    echo -e "${RED}Error:${NC} Plan script not found at: $plan_script" >&2
    exit 1
  fi

  if [[ ! -x "$plan_script" ]]; then
    chmod +x "$plan_script"
  fi

  echo -e "${CYAN}Starting Wavemill Plan...${NC}"
  exec "$plan_script" "$@"
}

# Main command dispatcher
case "${1:-}" in
  mill)
    check_claude_sync
    shift
    # Parse mill-specific flags before delegating
    while [[ $# -gt 0 ]]; do
      case "$1" in
        --agent)
          export AGENT_CMD="$2"
          shift 2
          ;;
        *)
          break
          ;;
      esac
    done
    run_mill "$@"
    ;;
  expand)
    check_claude_sync
    shift
    run_expand "$@"
    ;;
  plan)
    check_claude_sync
    shift
    run_plan "$@"
    ;;
  eval)
    shift
    run_eval "$@"
    ;;
  init)
    shift
    run_init "$@"
    ;;
  version|--version|-v)
    show_version
    ;;
  help|--help|-h|"")
    show_help
    ;;
  *)
    echo -e "${RED}Error:${NC} Unknown command: $1" >&2
    echo ""
    show_help
    exit 1
    ;;
esac
